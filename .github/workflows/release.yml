name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - patch
          - minor
          - major

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0
          fetch-tags: true

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Verify branches
        run: |
          git fetch origin main develop

          echo "Branches status:"
          echo "  develop: $(git rev-parse --short origin/develop)"
          echo "  main:    $(git rev-parse --short origin/main)"

          AHEAD=$(git rev-list origin/main..origin/develop --count)
          echo "  develop is $AHEAD commit(s) ahead of main"

          if [ "$AHEAD" -eq 0 ]; then
            echo "::error::develop has no new commits compared to main. Nothing to release."
            exit 1
          fi

      - name: Get current version
        id: current
        run: |
          CURRENT_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_TAG"

      - name: Analyze commits and determine bump
        id: analyze
        run: |
          CURRENT_TAG="${{ steps.current.outputs.tag }}"
          BUMP="${{ inputs.bump }}"

          if [ "$CURRENT_TAG" = "v0.0.0" ]; then
            COMMITS=$(git log origin/develop --pretty=format:"%s" --no-merges)
          else
            COMMITS=$(git log ${CURRENT_TAG}..origin/develop --pretty=format:"%s" --no-merges)
          fi

          echo "Commits to be released:"
          echo "$COMMITS"

          COMMIT_COUNT=$(echo "$COMMITS" | grep -c "." || echo "0")
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

          if [ "$BUMP" = "auto" ]; then
            if echo "$COMMITS" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?!:"; then
              BUMP="major"
            elif echo "$COMMITS" | grep -qiE "BREAKING CHANGE"; then
              BUMP="major"
            elif echo "$COMMITS" | grep -qE "^feat(\(.+\))?:"; then
              BUMP="minor"
            else
              BUMP="patch"
            fi
          fi

          echo "bump=$BUMP" >> $GITHUB_OUTPUT
          echo "Determined bump type: $BUMP"

      - name: Calculate new version
        id: version
        run: |
          CURRENT="${{ steps.current.outputs.tag }}"
          BUMP="${{ steps.analyze.outputs.bump }}"

          VERSION=${CURRENT#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          case "$BUMP" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          CURRENT_TAG="${{ steps.current.outputs.tag }}"
          NEW_VERSION="${{ steps.version.outputs.new }}"

          # Create changelog file
          echo "## What's Changed in $NEW_VERSION" > CHANGELOG.md
          echo "" >> CHANGELOG.md

          if [ "$CURRENT_TAG" = "v0.0.0" ]; then
            RANGE="origin/develop"
          else
            RANGE="${CURRENT_TAG}..origin/develop"
          fi

          # Features
          FEATS=$(git log $RANGE --pretty=format:"- %s" --no-merges | grep -E "^- feat(\(.+\))?:" || true)
          if [ -n "$FEATS" ]; then
            echo "### Features" >> CHANGELOG.md
            echo "$FEATS" | sed 's/^- feat(\([^)]*\)): /- **\1**: /' | sed 's/^- feat: /- /' >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Fixes
          FIXES=$(git log $RANGE --pretty=format:"- %s" --no-merges | grep -E "^- fix(\(.+\))?:" || true)
          if [ -n "$FIXES" ]; then
            echo "### Bug Fixes" >> CHANGELOG.md
            echo "$FIXES" | sed 's/^- fix(\([^)]*\)): /- **\1**: /' | sed 's/^- fix: /- /' >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Performance
          PERFS=$(git log $RANGE --pretty=format:"- %s" --no-merges | grep -E "^- perf(\(.+\))?:" || true)
          if [ -n "$PERFS" ]; then
            echo "### Performance" >> CHANGELOG.md
            echo "$PERFS" | sed 's/^- perf(\([^)]*\)): /- **\1**: /' | sed 's/^- perf: /- /' >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Docs
          DOCS=$(git log $RANGE --pretty=format:"- %s" --no-merges | grep -E "^- docs(\(.+\))?:" || true)
          if [ -n "$DOCS" ]; then
            echo "### Documentation" >> CHANGELOG.md
            echo "$DOCS" | sed 's/^- docs(\([^)]*\)): /- **\1**: /' | sed 's/^- docs: /- /' >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Others
          OTHERS=$(git log $RANGE --pretty=format:"- %s" --no-merges | grep -vE "^- (feat|fix|perf|docs)(\(.+\))?:" || true)
          if [ -n "$OTHERS" ]; then
            echo "### Other Changes" >> CHANGELOG.md
            echo "$OTHERS" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${CURRENT_TAG}...${NEW_VERSION}" >> CHANGELOG.md

          cat CHANGELOG.md

      - name: Create release PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          NEW_VERSION="${{ steps.version.outputs.new }}"

          # Build PR body
          PR_BODY=$(cat CHANGELOG.md)
          PR_BODY="${PR_BODY}

          ---

          > **Auto-generated release PR**
          > Merging this PR will automatically create tag \`${NEW_VERSION}\` and publish the release.
          >
          > Version bump: **${{ steps.analyze.outputs.bump }}** (${{ steps.current.outputs.tag }} â†’ ${NEW_VERSION})"

          # Check if PR already exists
          EXISTING_PR=$(gh pr list --base main --head develop --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ] && [ "$EXISTING_PR" != "null" ]; then
            echo "Release PR #$EXISTING_PR already exists. Updating..."
            gh pr edit "$EXISTING_PR" \
              --title "ðŸš€ Release $NEW_VERSION" \
              --body "$PR_BODY"
            echo "pr_url=https://github.com/${{ github.repository }}/pull/$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "PR updated: https://github.com/${{ github.repository }}/pull/$EXISTING_PR"
          else
            echo "Creating new release PR..."
            PR_URL=$(gh pr create \
              --base main \
              --head develop \
              --title "ðŸš€ Release $NEW_VERSION" \
              --body "$PR_BODY")
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
            echo "PR created: $PR_URL"
          fi

      - name: Summary
        run: |
          echo "## ðŸš€ Release Preparation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Current version | \`${{ steps.current.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| New version | \`${{ steps.version.outputs.new }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Bump type | ${{ steps.analyze.outputs.bump }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commits | ${{ steps.analyze.outputs.commit_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the release PR" >> $GITHUB_STEP_SUMMARY
          echo "2. Approve and merge the PR" >> $GITHUB_STEP_SUMMARY
          echo "3. The release will be automatically published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Changelog Preview" >> $GITHUB_STEP_SUMMARY
          cat CHANGELOG.md >> $GITHUB_STEP_SUMMARY
