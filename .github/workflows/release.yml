name: Create Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - patch
          - minor
          - major
      dry_run:
        description: 'Dry run (no actual release)'
        required: false
        default: false
        type: boolean

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0
          fetch-tags: true

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Verify branches exist
        run: |
          # Verify develop and main exist
          git fetch origin main develop

          echo "Branches status:"
          echo "  develop: $(git rev-parse --short origin/develop)"
          echo "  main:    $(git rev-parse --short origin/main)"

          # Check if develop is ahead of main
          AHEAD=$(git rev-list origin/main..origin/develop --count)
          echo "  develop is $AHEAD commit(s) ahead of main"

          if [ "$AHEAD" -eq 0 ]; then
            echo "::warning::develop has no new commits compared to main"
          fi

      - name: Get current version
        id: current
        run: |
          CURRENT_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_TAG"

      - name: Analyze commits and determine bump
        id: analyze
        run: |
          CURRENT_TAG="${{ steps.current.outputs.tag }}"
          BUMP="${{ inputs.bump }}"

          # Get commits on develop since last tag (commits that will be released)
          if [ "$CURRENT_TAG" = "v0.0.0" ]; then
            COMMITS=$(git log origin/develop --pretty=format:"%s" --no-merges)
          else
            COMMITS=$(git log ${CURRENT_TAG}..origin/develop --pretty=format:"%s" --no-merges)
          fi

          echo "Commits to be released:"
          echo "$COMMITS"
          echo ""

          # Count commits
          COMMIT_COUNT=$(echo "$COMMITS" | grep -c "." || echo "0")
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

          if [ "$COMMIT_COUNT" -eq 0 ]; then
            echo "::error::No commits to release"
            exit 1
          fi

          # Auto-detect bump type from conventional commits
          if [ "$BUMP" = "auto" ]; then
            if echo "$COMMITS" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?!:"; then
              BUMP="major"
            elif echo "$COMMITS" | grep -qiE "BREAKING CHANGE"; then
              BUMP="major"
            elif echo "$COMMITS" | grep -qE "^feat(\(.+\))?:"; then
              BUMP="minor"
            else
              BUMP="patch"
            fi
          fi

          echo "bump=$BUMP" >> $GITHUB_OUTPUT
          echo "Determined bump type: $BUMP"

      - name: Calculate new version
        id: version
        run: |
          CURRENT="${{ steps.current.outputs.tag }}"
          BUMP="${{ steps.analyze.outputs.bump }}"

          # Remove 'v' prefix
          VERSION=${CURRENT#v}

          # Split version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # Bump version
          case "$BUMP" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          CURRENT_TAG="${{ steps.current.outputs.tag }}"
          NEW_VERSION="${{ steps.version.outputs.new }}"

          echo "## What's Changed in $NEW_VERSION" > CHANGELOG.md
          echo "" >> CHANGELOG.md

          # Get commits since last tag on develop
          if [ "$CURRENT_TAG" = "v0.0.0" ]; then
            RANGE="origin/develop"
          else
            RANGE="${CURRENT_TAG}..origin/develop"
          fi

          # Features
          FEATS=$(git log $RANGE --pretty=format:"- %s" --no-merges | grep -E "^- feat(\(.+\))?:" || true)
          if [ -n "$FEATS" ]; then
            echo "### Features" >> CHANGELOG.md
            echo "$FEATS" | sed 's/^- feat(\([^)]*\)): /- **\1**: /' | sed 's/^- feat: /- /' >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Fixes
          FIXES=$(git log $RANGE --pretty=format:"- %s" --no-merges | grep -E "^- fix(\(.+\))?:" || true)
          if [ -n "$FIXES" ]; then
            echo "### Bug Fixes" >> CHANGELOG.md
            echo "$FIXES" | sed 's/^- fix(\([^)]*\)): /- **\1**: /' | sed 's/^- fix: /- /' >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Performance
          PERFS=$(git log $RANGE --pretty=format:"- %s" --no-merges | grep -E "^- perf(\(.+\))?:" || true)
          if [ -n "$PERFS" ]; then
            echo "### Performance" >> CHANGELOG.md
            echo "$PERFS" | sed 's/^- perf(\([^)]*\)): /- **\1**: /' | sed 's/^- perf: /- /' >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Documentation
          DOCS=$(git log $RANGE --pretty=format:"- %s" --no-merges | grep -E "^- docs(\(.+\))?:" || true)
          if [ -n "$DOCS" ]; then
            echo "### Documentation" >> CHANGELOG.md
            echo "$DOCS" | sed 's/^- docs(\([^)]*\)): /- **\1**: /' | sed 's/^- docs: /- /' >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Other changes (chore, refactor, style, test, ci, build)
          OTHERS=$(git log $RANGE --pretty=format:"- %s" --no-merges | grep -vE "^- (feat|fix|perf|docs)(\(.+\))?:" || true)
          if [ -n "$OTHERS" ]; then
            echo "### Other Changes" >> CHANGELOG.md
            echo "$OTHERS" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${CURRENT_TAG}...${NEW_VERSION}" >> CHANGELOG.md

          echo "Generated changelog:"
          cat CHANGELOG.md

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        run: |
          echo "::notice::DRY RUN - No changes will be made"
          echo ""
          echo "=== Release Summary ==="
          echo "Current version: ${{ steps.current.outputs.tag }}"
          echo "New version:     ${{ steps.version.outputs.new }}"
          echo "Bump type:       ${{ steps.analyze.outputs.bump }}"
          echo "Commits:         ${{ steps.analyze.outputs.commit_count }}"
          echo ""
          echo "=== Changelog ==="
          cat CHANGELOG.md
          echo ""
          echo "=== Actions that would be performed ==="
          echo "1. Merge develop into main"
          echo "2. Create tag ${{ steps.version.outputs.new }} on main"
          echo "3. Create GitHub Release"
          echo "4. Sync main back to develop"

      - name: Merge develop into main
        if: ${{ !inputs.dry_run }}
        run: |
          echo "Merging develop into main..."

          # Checkout main
          git checkout main
          git pull origin main

          # Merge develop into main (no fast-forward to keep history clear)
          git merge origin/develop --no-ff -m "chore(release): merge develop into main for ${{ steps.version.outputs.new }}"

          # Push main
          git push origin main

          echo "Successfully merged develop into main"

      - name: Create tag and release
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          NEW_VERSION="${{ steps.version.outputs.new }}"

          # Ensure we're on main
          git checkout main

          # Create tag on main
          git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"
          git push origin "$NEW_VERSION"

          # Create GitHub Release
          gh release create "$NEW_VERSION" \
            --title "$NEW_VERSION" \
            --notes-file CHANGELOG.md \
            --target main

          echo "Release $NEW_VERSION created on main!"

      - name: Sync main back to develop
        if: ${{ !inputs.dry_run }}
        run: |
          echo "Syncing main back to develop..."

          # Checkout develop
          git checkout develop
          git pull origin develop

          # Merge main into develop (to get the merge commit and tag)
          git merge main --no-ff -m "chore: sync main (${{ steps.version.outputs.new }}) back to develop"

          # Push develop
          git push origin develop

          echo "Successfully synced main back to develop"

      - name: Summary
        if: ${{ !inputs.dry_run }}
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Previous version | ${{ steps.current.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| New version | ${{ steps.version.outputs.new }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bump type | ${{ steps.analyze.outputs.bump }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commits released | ${{ steps.analyze.outputs.commit_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Actions performed" >> $GITHUB_STEP_SUMMARY
          echo "1. ✅ Merged \`develop\` into \`main\`" >> $GITHUB_STEP_SUMMARY
          echo "2. ✅ Created tag \`${{ steps.version.outputs.new }}\` on \`main\`" >> $GITHUB_STEP_SUMMARY
          echo "3. ✅ Created GitHub Release" >> $GITHUB_STEP_SUMMARY
          echo "4. ✅ Synced \`main\` back to \`develop\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changelog" >> $GITHUB_STEP_SUMMARY
          cat CHANGELOG.md >> $GITHUB_STEP_SUMMARY
